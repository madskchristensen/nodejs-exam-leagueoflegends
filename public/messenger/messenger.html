<link rel="stylesheet" href="messenger.css">

<div class="container">
    <div class="row py-5" >
        <div id="chats-div" class="col col-3">
            <h4>Chats</h4>
            <input type="text" id="new-conversation-input" class="form-control pt-2 mb-3 mt-3" placeholder="New chat: Type receiver name here" >
            <div id="messages-div" class="list-group pt-2" role="tablist">

            </div>
        </div>
        <div class="col col-9" id="messenger">
            <div class="tab-content" id="messenger-div">

            </div>
            <div class="row mt-5">
                <input type="text" placeholder="Type your message here..." class="mt-2 py-1" id="message-input">
                <button onclick="sendPrivateMessage()">Send message</button>
            </div>

        </div>

    </div>
</div>

<script src="/messenger/messenger.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();
    // get session
    const session = getSession();
    // save current user summoner name
    // const socketIdentifier = session.session.profile.summonerName;
    // test identifier for now
    const socketIdentifier = "Jensen";

    function sendPrivateMessage() {
        const message = document.getElementById("message-input").value;
        // get name of receiver
        let receiver;

        // get new conversation input field to check if new message
        const newConversationInput = document.getElementById("new-conversation-input").value;
        const messagesDiv = document.getElementById("messages-div");

        // if nothing inside newConversationInput normal workflow
        if (newConversationInput === "") {
            const activeConversationDiv = document.getElementsByClassName("list-group-item list-group-item-action conversation-link active");
            receiver = activeConversationDiv[0].id;
        }
        else {
            receiver = newConversationInput;
        }

        // emit message
        socket.emit("private message", { receiver, message, socketIdentifier });
        
        // create html elements

        // create conversation partner object
        const conversationPartner = {
            riot: {
                summonerName: receiver,
                // TO DO
                // fetch summoner from db. Default icon for now
                summonerIcon: "1"
            }
        }

        // create lastMessage object
        const lastMessage = {
            from: socketIdentifier,
            body: message
        }

        // if new convo input isn't empty new conversation element is to be made
        let listConversationDiv;


        
        // attach message to div
        const wrapperMessageDiv = document.createElement("div");
        wrapperMessageDiv.classList.add("row");

        const messageDiv = document.createElement("div");
        messageDiv.classList.add("col", "col-4", "my-1", "rounded-start");

        const messageText = document.createElement("p");
        messageText.classList.add("message-text")
        messageText.innerText = message;
        
        wrapperMessageDiv.classList.add("justify-content-end")
        messageDiv.classList.add("chat-right", "d-flex", "justify-content-end", "align-items-center");    

        messageDiv.appendChild(messageText);
        wrapperMessageDiv.appendChild(messageDiv);
        // create new chat div and conversation element if new chat
        if (newConversationInput !== "") {
            generateConversation (conversationPartner, socketIdentifier, lastMessage, messagesDiv); 

            // create messager div
            const listConversationDiv = document.createElement("div");
            listConversationDiv.classList.add("tab-pane", "fade", "row");
            listConversationDiv.setAttribute("role", "tabpanel");
            listConversationDiv.setAttribute("aria-labelledby", receiver);
            listConversationDiv.id = "list-" + receiver;

            listConversationDiv.appendChild(wrapperMessageDiv);
        }
        else {
            // if conversation already had attach to active chat
            listConversationDiv =  document.getElementsByClassName("tab-pane fade row active show");
            listConversationDiv[0].appendChild(wrapperMessageDiv);

        }

    }

    socket.on("private message", (data) => {
        // see who message is from
        // if "from" is in current chat divs, add message to conversation
        // else maybe add new convo 
        const listConversationDiv = document.getElementById("list-" + data.from )

        if (!listConversationDiv !== undefined) {
            const wrapperMessageDiv = document.createElement("div");
            wrapperMessageDiv.classList.add("row");

            const messageDiv = document.createElement("div");
            messageDiv.classList.add("col", "col-4", "my-1", "rounded-start");

            const messageText = document.createElement("p");
            messageText.classList.add("message-text")
            messageText.innerText = data.message;
        
            messageDiv.classList.add("chat-left", "d-flex", "justify-content-start");
            
            messageDiv.appendChild(messageText);
            wrapperMessageDiv.appendChild(messageDiv);
            listConversationDiv.appendChild(wrapperMessageDiv);
        }
        else{
            // TO DO 
            // create new chat with given user
            console.log("Message was sent to new user");
        }
    })
</script>