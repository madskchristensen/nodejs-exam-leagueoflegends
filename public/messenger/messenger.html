<link rel="stylesheet" href="messenger.css">

<div class="container">
    <div class="row py-5" >
        <div id="chats-div" class="col col-3">
            <h4>Chats</h4>
            <input type="text" id="new-conversation-input" class="form-control pt-2 mb-3 mt-3" placeholder="New chat: Type receiver name here" >
            <div id="select-div">
                <select class="form-select form-select-sm" id="select-region">
                    <!-- Backend region names atm. should be translated to actual region names-->
                    <option selected>euw1</option>
                    <option>na1</option>
                    <option>eune1</option>
                    <option>kr1</option>
                    <option>br1</option>
                    <option>lan1</option>
                    <option>las1</option>
                    <option>oce1</option>
                    <option>ru1</option>
                    <option>tr1</option>
                    <option>jp1</option>
                </select>
            </div>
            <div id="messages-div" class="list-group pt-3" role="tablist">

            </div>
        </div>
        <div class="col col-9" id="messenger">
            <div class="tab-content" id="messenger-div">

            </div>
            <div class="row mt-5">
                <input type="text" placeholder="Type your message here..." class="mt-2 py-1" id="message-input">
                <button onclick="sendPrivateMessage()">Send message</button>
            </div>

        </div>

    </div>
</div>

<script src="/messenger/messenger.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();
        // get session
        let loggedInUser;
        getUser().then((result) => {
            loggedInUser = result;
        });

    async function sendPrivateMessage() {
        // save current user summoner name
        const socketIdentifier = loggedInUser.riot.summonerName;
        const message = document.getElementById("message-input").value;

        // get new conversation input field to check if new message
        const newConversationInput = document.getElementById("new-conversation-input").value;
        const newConversationRegion = document.getElementById("select-region").value;
        const messagesDiv = document.getElementById("messages-div");

        // get name of receiver
        let receiver = {};
        // if nothing inside newConversationInput normal workflow
        if (newConversationInput === "") {
            // get active conversation
            const activeConversationDiv = document.getElementsByClassName("list-group-item list-group-item-action conversation-link active")[0];
            const conversationIdentifierArr = activeConversationDiv.id.split("-");

            receiver.summonerName = conversationIdentifierArr[0];
            receiver.region = conversationIdentifierArr[1];
        }
        else {
            receiver.summonerName = newConversationInput;
            receiver.region = newConversationRegion;
        }

        // emit message
        socket.emit("private message", { receiver, message });

        // If no new chat. attach message to active messenger window
        // TO DO
        // currently doesn't check if conversation was already had - only if user chooses to create a new conversation
        if (newConversationInput === "") {
            listConversationDiv = document.getElementsByClassName("tab-pane fade row active show");
            generateMessage (message, socketIdentifier, socketIdentifier, listConversationDiv[0])
        }
        // if new chat create new chat 
        else {
            // fetch user from DB
            const conversationPartner = await getUserFromDB(receiver.region, receiver.summonerName);
            if (conversationPartner) {
                // create lastMessage object
                const lastMessage = {
                    from: socketIdentifier,
                    body: message
                }

                // get wrapper divs for conversations (left) and messenger (right)             
                const messagesDiv = document.getElementById("messages-div");
                const messengerDiv = document.getElementById("messenger-div")

                // create new conversation element to the left
                generateConversation (conversationPartner, socketIdentifier, lastMessage, messagesDiv); 

                // create messenger div
                const listConversationDiv = generateMessageContainer(receiver.summonerName, receiver.region);

                // attach message to messenger div
                generateMessage (message, socketIdentifier, socketIdentifier, listConversationDiv)
                messengerDiv.appendChild(listConversationDiv);

                resetNewConversationInput();
            }
            else {
                alert("Summoner not found - please try again");

            }
        }
        // reste message input
        document.getElementById("message-input").value = ""
    }

    socket.on("private message", async (data) => {
        // see who message is from
        // if "from" is in current chat divs, add message to conversation
        // else maybe add new convo 
        const listConversationDiv = document.getElementById("list-" + data.from )
        console.log(data);
        if (listConversationDiv) {
            generateMessage (data.message, data.from, data.to, listConversationDiv);
        }
        else{
            // get region and summoner name
            const senderRegionAndSummonerName = data.from.split("-");
            const senderSummonerName = senderRegionAndSummonerName[0];
            const senderRegion = senderRegionAndSummonerName[1];

            // create conversation partner object
            const conversationPartner = await getUserFromDB(senderRegion, senderSummonerName);


            // create lastMessage object
            const lastMessage = {
                from: conversationPartner._id,
                body: data.message
            }
            
            // get wrapper divs for conversations (left) and messenger (right)             
            const messagesDiv = document.getElementById("messages-div");
            const messengerDiv = document.getElementById("messenger-div")

            // create new conversation element to the left
            generateConversation (conversationPartner, conversationPartner.riot.summonerName, lastMessage, messagesDiv); 

            // create messenger div
            const listConversationDiv = generateMessageContainer(conversationPartner.riot.summonerName, conversationPartner.riot.region);

            // get receiver summoner name
            const receiverSummonerName = data.to.split("-")[0]
            // attach message to messenger div
            generateMessage (data.message, conversationPartner.riot.summonerName, receiverSummonerName, listConversationDiv)
            messengerDiv.appendChild(listConversationDiv);
        }
    })
</script>