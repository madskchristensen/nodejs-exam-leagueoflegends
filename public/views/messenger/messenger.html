<link rel="stylesheet" href="/views/messenger/messenger.css">

<div class="container">
    <div class="row pt-5" >
        <div id="chats-div" class="col col-3 squared-div pt-3">
            <h4>Chats</h4>
            <input type="text" id="new-conversation-input" class="form-control pt-2 mb-3 mt-3" placeholder="New chat: Type receiver name here" >
            <div id="select-div">
                <select class="form-select form-select-sm" id="select-region">
                    <option selected>euw</option>
                    <option>na</option>
                    <option>eune</option>
                    <option>kr</option>
                    <option>br</option>
                    <option>lan</option>
                    <option>las</option>
                    <option>oce</option>
                    <option>ru</option>
                    <option>tr</option>
                    <option>jp</option>
                </select>
            </div>
            <div id="conversations-div" class="list-group pt-3" role="tablist">

            </div>
        </div>
        <div class="col col-9 squared-div" id="messenger">
            <div class="tab-content" id="messenger-div">

            </div>
            <div class="row mt-5">
                <input type="text" placeholder="Type your message here..." class="mt-2 py-1" id="message-input">
            </div>
        </div>
    </div>
</div>

<script type="module" src="/views/messenger/messenger.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script type="module">
    import { getLoggedInUser, getUser } from "/js/api.js";
    import { generateConversation, generateMessengerContainer, generateMessage, resetMessageInputs } from "/views/messenger/messenger.js";

    const socket = io();
    
    // get session
    let loggedInUser;

    getLoggedInUser().then((result) => {
        loggedInUser = result;
    });

    // get message input 
    const sendMessageInput = document.getElementById("message-input");

    // attach listerner to message input field on enter keypress
    sendMessageInput.addEventListener("keyup", (event) => {
        // e.keyCode for legacy browsers
        if (event.keyCode === 13 || event.key === 'Enter') {
            sendPrivateMessage();
        }
    });

    // gets receiver, checks if input is valid and emits private message back to server
    async function sendPrivateMessage() {
        // save get user summoner name
        const socketIdentifier = loggedInUser.riot.summonerName;

        // get message body
        const message = document.getElementById("message-input").value;

        // get new conversation input field to check if new message
        const newConversationSummonerName = document.getElementById("new-conversation-input").value;
        const newConversationRegion = document.getElementById("select-region").value;

        // get name of receiver
        let receiver;

        // if nothing inside newConversationInput ==> message sent to existing chat ==> append message to chat
        if (!newConversationSummonerName) {
            // get active conversation element
            const activeConversationDiv = document.getElementsByClassName("list-group-item list-group-item-action conversation-link active")[0];
            
            // extract reciver name and id ("summonerName"-"region") from HTML element id
            const receiverSummonerNameAndRegion = activeConversationDiv.id.split("-");

            receiver = {
                summonerName: receiverSummonerNameAndRegion[0],
                region: receiverSummonerNameAndRegion[1]
            }
        
        // get new conversation receiver name from new conversation inputs (summonerName and region)
        } else {
            receiver = {
                summonerName: newConversationSummonerName,
                region: newConversationRegion
            }
        }

        // get receiver of message (to) from DB
        const to = await getUser(receiver.summonerName, receiver.region);

        // check if recveiver exists
        if (!to) {
            toastr.error("Summoner not found - please try again.");
        
        // check if receiver is identical to logged in user
        } else if (to.riot.summonerName === loggedInUser.riot.summonerName && to.riot.region === loggedInUser.riot.region ) {
            toastr.error("You can't send messages to yourself. Get a life...");
        
        // emit message to server
        } else {
            socket.emit("private message", { to, message });

            // reset message and conversation inputs
            resetMessageInputs();
        }
    }

    socket.on("private message", async (data) => {
        
        // get messenger div from data
        const messengerDiv = document.getElementById("list-" + data.from.riot.summonerName + "-"  + data.from.riot.region);
        
        // if messenger element already exists ==> conversation already had ==> append message to existing chat
        if (messengerDiv) {
            // attach message to messenger div according to if data was sent to self or not
            if (data.toSelf) {
                generateMessage (data.message, data.from._id, data.from._id, messengerDiv);

            } else {
                generateMessage (data.message, data.from._id, data.to._id, messengerDiv);
            }

        // else create new conversation, messenger and message
        } else {
            // create lastMessage for conversation element
            let lastMessage = {
                body: data.message,
            };

            // set sender of last message according to if data was sent to self or not
            if (data.toSelf) {
                lastMessage.from = data.to._id;
            
            } else {
                lastMessage.from = data.from._id;
            }
            
            // get wrapper div for conversations (left) and messenger (right)
            const conversationsDiv = document.getElementById("conversations-div");
            const messengerDiv = document.getElementById("messenger-div");

            // create new conversation element (left)
            generateConversation (data.from, data.from.riot.summonerName, lastMessage, conversationsDiv); 

            // create messenger container for new chat (right)
            const messengerContainer = generateMessengerContainer(data.from.riot.summonerName, data.from.riot.region);
            
            // attach message to messenger div according to if data was sent to self or not
            if (data.toSelf) {
                generateMessage (data.message, data.from._id, data.from._id, messengerContainer);

            } else {
                generateMessage (data.message, data.from._id, data.to._id, messengerContainer);
            }

            // append messengerContainer to messenger wrapper
            messengerDiv.appendChild(messengerContainer);
        }
    })
</script>
